## Слой Консенсуса

Прежде всего при подключении к сети каждый узел пару генерирует ассиметричных ключей шифрования и идентификатор node_id и , с помощью которых узел будет осуществлять подпись. Генерация идентификатора и ключей происходит следующим образом: берется хэш от публичного ключа и полагается node_id, сам хэш должен содержать определенное количество ведущих нулей, называемой сложностью. Если это число достигнуто, значит инициализация завершена. Этот proof-of-work процесс является одним из ключевых моментов: во первых защищает от татаки Сибиллы. Во вторых чем выше сложность, тем надежнее будет считаться сам узел, от этой сложности будет зависить степень доверия к подписанным им данным. Степень доверия и сложность хэша от публичного ключа будут синонимами.

## Цикл жизни пары ключ/значение от её появления до помещения в блокчейн. 

Для определенности предположим, что БЧ управляет цифровой валютой и оперирует транзакциями. Транзакция представляет из себя тройку
<номер счета отправителя, номер счета получателя, количество>, плюс хэш от предыдущей транзакции.
После появления на одном из узлов сети транзакции к ней прикрепляется штамп даты и структура данных [δ-CRDT GSet](https://arxiv.org/abs/1603.01529) (Grow Only Set), которая будет содержать подписи. Узел подписывает транзакцию, ложит подпись в GSet и отправляет этого кандидата на влючение в БЧ всем соседям черз слой P2P. При получении кандидата на узле происходит валидация, при которой кропе основных проверок на корректность счета осуществляется проверка на то что среди уже подписанных этим узлом транзакций нет такой, ссылалась бы на туже самую предыдущюю транзакцию, для того чтобы исключить ветвление. После валидации производится подпись, и конверт с обновленными подписви рассылается далее. Если пришедший конверт уже содержит подпись, то локальный GSet для этой транзакции обновляется, добавляя подписи от других узлов. Процесс завершается при получении 2/3 подписей. Транзакция получившая такие подписи записывается в блок, сам блок сохраняется физически при заполнеии им транзакциями.
Интересной особенностью будет являтся также то, что транзакции в блокчейне будут упорядоченные не линейным (тотальным) порядком, а по принципу причино-следственных связей. Прикрепляемый штамп времени - это показания логических часов, которые разделяют все узлы БЧ. Фактически БЧ на 2х отдельно взятых узлах будет не идентичным, а изоморфным относительно причинночтного отношения, образуемого этими часами. Другим словами это будут 2 топологические сортировки одного и тогоже направленного ацикличного графа (или эквиволентными исполнениями в терминах модели Лэмпорта). Кроме этого подиписи транзакций на разных узлах, вообще говоря может отличаться.


Траффик, образующиый при такой пересылки будет не таким большим, т.к. δ-CRDT обмениваются только различными элементами. При помощи техник ([статья](https://open.bu.edu/bitstream/handle/2144/1665/2002-019-approx-reconciliation.pdf) [статья](https://arxiv.org/abs/1803.02750)) и при учете оценок распространения слухов [статья](https://zoo.cs.yale.edu/classes/cs426/2013/bib/karp00randomized.pdf), количество пересылок и объем будет значительно менше чем верхняя оценка O(N^2).

Попробуем провести некоторые расчеты по скорости фиксации транзакции и требуемым ресурсам.

Будем отталкиваться от следующих цифр: за аудиторию пользователей примем 5 млрд. человек. Предположим, что N-количество узлов в сети будет приблизительно 10000. Значит один узел будет обслуживать в среднем до полумиллиона человек. Представляется что раз в секунду на один сервер будет приходить до 2000 транзакций (5 транзакций в день на человека). Для каждой транзакции нужно получить 7000 подписей, чтобы она могла быть зафиксированна в блокчейне. Одна подпись будет знаимать (подпись + ключ + id) 500 байт. Т.е. по грубой оценке 1 транзакция вместе с подписями может занимать до 2х Mb, а это 4 Gb в секунду. Учитывая оценку распространения слухов в полной сети ([статья](https://zoo.cs.yale.edu/classes/cs426/2013/bib/karp00randomized.pdf)) и оптимизированный алгоритм антиэнтропии для δ-CRDT получаем суммарный траффик для подписывания 1й транзакции равный 500b*N*logN ~ 5Mb. Объем хранимой информации при этом, при пересчете на одного человека, будет несколько гигабайт в год, что суммарно для всех людей дает астрономическую цифру, и это представляется пока главной проблемой всей этой схемы - как хранить подписанные транзакции в сжатом виде.

Описанная выше ситуация является крайним случаем. К примеру, фактическое количество BTC кошельков на Q1'2018 составляет чуть менее 25 млн. А вот количество узлов сети BTC порядка 10000. К примеру уменьшая количество узлов, требуемая память резко снижается.

К доверию подписей можно отнестись более интеллектуально, что позволит свести расходы по хранению на приемлемый уровень. Надежность узла, задаваемая степенью сложности хэша от публичного ключа, найденного при старте, можно отнести и к степени доверия самой подписи этого узла. Так для определения того, что транзакция подписанна на достаточном от подделок уровне (2/3 по принципам BFT) можно испольовать некую формулу, зависящюю от композиции сложностей всех существующих подписей. Очевидно, что эта формула должна принимать во внимание текуще технические возможности по нахождению "сложных" хэшей, а также, возможно количество узлов в сети. При использовании подобного подхода количество требуемых подписей существенно снижается.

Одним из улушений считается требование к тому, что нода должна периодически пересчитывать хэш и ключ, т.е. обновляться с тточки зрения остальных узлов. Другим можно положить введения эпох, в рамках которых будет подсчитываться количество сумарная произведенная сложность, и в соответствии с этим переситываться порог при которой сумма сложностей всех подписей для транзакции считается приемлемой для включения в блок. 

Дальнейшие детали предложенного алгоритма ведения консенсуса в БЧ относятся к [хранилищу, и описанны далее.](Database.md)
